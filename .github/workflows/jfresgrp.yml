name: 'jfterraform'

on:
  push:
    branches:
    - main
  pull_request:

jobs:
  jfterraform:
    name: 'jfterraform'
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}
      JFROG_URL: ${{ secrets.JFROG_URL }}
      JFROG_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}
      ARTIFACTORY_BACKEND_VERSION: "1.0.4"
    runs-on: ubuntu-latest
    environment: dev

    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    
    - name: Install Artifactory backend plugin (inline)
      shell: bash
      run: |
          set -euo pipefail
          VERSION="${ARTIFACTORY_BACKEND_VERSION}"
          ARCH="$(uname -m)"
          if [[ "$ARCH" == "x86_64" ]]; then OS_ARCH="linux_amd64"; elif [[ "$ARCH" == "aarch64" || "$ARCH" == "arm64" ]]; then OS_ARCH="linux_arm64"; else echo "Unsupported arch: $ARCH"; exit 1; fi
          PLUGIN_ROOT="$HOME/.terraform.d/plugins/registry.terraform.io/jfrog/artifactory/${VERSION}/${OS_ARCH}"
          echo "plugin root ${PLUGIN_ROOT}"
          ZIP="terraform-backend-artifactory_${VERSION}_${OS_ARCH}.zip"
          ZIP1="terraform-backend-artifactory_${VERSION}_${OS_ARCH}"
          URL="https://github.com/jfrog/terraform-backend-artifactory/releases/download/v${VERSION}/${ZIP}"
          sudo apt-get update && sudo apt-get install -y curl unzip
          mkdir -p "${PLUGIN_ROOT}"
          TMP_DIR="$(mktemp -d)"
          echo "temp_dir to ${TMP_DIR}"
          curl -L -o "${TMP_DIR}/${ZIP}" "${URL}"
          unzip -o "${TMP_DIR}/${ZIP1}" -d "${PLUGIN_ROOT}" >/dev/null
          if [[ -f "${PLUGIN_ROOT}/${ZIP1}" ]]; then
            chmod +x "${PLUGIN_ROOT}/${ZIP1}"
          else
            CANDIDATE=$(find "${PLUGIN_ROOT}" -maxdepth 1 -type f -perm -u+x | head -n 1)
            mv "$CANDIDATE" "${PLUGIN_ROOT}/${ZIP1}"
            chmod +x "${PLUGIN_ROOT}/${ZIP1}"
          fi
          rm -rf "${TMP_DIR}"
          echo "Installed to ${PLUGIN_ROOT}"

    - name: 'Terraform Format'
      uses: hashicorp/terraform-github-actions@master
      with:
        tf_actions_version: 0.14.8
        tf_actions_subcommand: 'fmt'
        tf_actions_working_dir: "./jfterraform"
        
    - name: 'Terraform Init'
      uses: hashicorp/terraform-github-actions@master
      with:
        tf_actions_version: 0.14.8
        tf_actions_subcommand: 'init'
        tf_actions_working_dir: "./jfterraform"

    - name: 'Terraform Validate'
      uses: hashicorp/terraform-github-actions@master
      with:
        tf_actions_version: 0.14.8
        tf_actions_subcommand: 'validate'
        tf_actions_working_dir: "./jfterraform"
        
    - name: 'Terraform Plan'
      uses: hashicorp/terraform-github-actions@master
      with:
        tf_actions_version: 0.14.8
        tf_actions_subcommand: 'plan'
        tf_actions_working_dir: "./jfterraform"

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main'
      uses: hashicorp/terraform-github-actions@master
      with:
        tf_actions_version: 0.14.8
        tf_actions_subcommand: 'apply'
        tf_actions_working_dir: "./jfterraform"
